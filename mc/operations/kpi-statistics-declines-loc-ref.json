{
  "name": "kpi-statistics-declines-loc-ref",
  "operation-type": "search",
  "index": "{{ wheretosearch|default('mc-rally-trx') }}",
  "body":{
    "size":0,
    "query":{
      "bool": {
        "filter": [
          {
            "terms": {
              "status": [
                "DECLINED"
              ],
              "boost": 1
            }
          },
          {
            "exists": {
              "field": "resultCode",
              "boost": 1
            }
          },
          {
            "range": {
              "transactionDate": {
                "from": "2018-07-17",
                "to": "2018-07-18",
                "include_lower": true,
                "include_upper": false,
                "format": "yyyy-MM-dd",
                "boost": 1
              }
            }
          },
          {
            "terms": {
              "location.externalRef": {
                "index": "mc-1shard-hierarchies",
                "type": "hierarchy",
                "id": "{{ division_id }}",
                "path": "locationIDs"
              },
              "boost": 1
            }
          }
        ],
        "disable_coord": false,
        "adjust_pure_negative": true,
        "boost": 1
      }
    },
    "aggs": {
      "AGGREGATION_KEY_1": {
        "terms": {
          "field": "resultCode",
          "size": 10000,
          "min_doc_count": 1,
          "shard_min_doc_count": 0,
          "show_term_doc_count_error": false,
          "order": [
            {
              "_count": "desc"
            },
            {
              "_term": "asc"
            }
          ]
        },
        "aggregations": {
          "SUM": {
            "sum": {
              "field": "transactionAmount"
            }
          }
        }
      }
    }
  }
}
